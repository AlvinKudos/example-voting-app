version: '1.0'
steps:
  BuildingDockerImage:
    title: Building Docker Image
    type: build
    image_name: example-voting-app/result
    working_directory: ./result/
    tag: '${{CF_BRANCH_TAG_NORMALIZED}}-${{CF_SHORT_REVISION}}'
    dockerfile: Dockerfile
    on_success:
      metadata:
        set:
          - '${{BuildingDockerImage.imageId}}':
            - CF_QUALITY: true
            - Performance: true
            - Latency: ".89" 
            - Test_Coverage: "83%"
            - JIRA: "https://codefresh-io.atlassian.net/browse/MKTG-12"
  CheckClair:
    image: codefresh/cfstep-paclair:3.0.0
    environment:
      - IMAGE=example-voting-app/result
      - TAG=${{CF_BRANCH_TAG_NORMALIZED}}-${{CF_SHORT_REVISION}}
  ArchiveReport:
    title: Upload Clair Report
    image: codefresh/cf-docker-test-reporting
    environment:
      - REPORT_INDEX_FILE=clair-scan-example-voting-app-result-${{CF_BRANCH_TAG_NORMALIZED}}-${{CF_SHORT_REVISION}}.html
